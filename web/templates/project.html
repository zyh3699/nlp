{% extends "base.html" %}

{% block title %}{{ project_name }} - Paper2Agent{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Project Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">é¦–é¡µ</a></li>
                    <li class="breadcrumb-item active">{{ project_name }}</li>
                </ol>
            </nav>
            
            <div class="card mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                <div class="card-body p-4">
                    <h1 class="display-5 mb-3">
                        <i class="bi bi-folder-fill"></i> {{ project_name }}
                    </h1>
                    <div class="row">
                        <div class="col-md-3">
                            <h4 id="toolsCount">0</h4>
                            <small>ç”Ÿæˆçš„å·¥å…·</small>
                        </div>
                        <div class="col-md-3">
                            <h4 id="completedSteps">0/10</h4>
                            <small>å®Œæˆæ­¥éª¤</small>
                        </div>
                        <div class="col-md-3">
                            <h4 id="mcpStatus">-</h4>
                            <small>MCP çŠ¶æ€</small>
                        </div>
                        <div class="col-md-3">
                            <h4 id="progress">0%</h4>
                            <small>æ€»ä½“è¿›åº¦</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-pills mb-4" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#pipeline">
                <i class="bi bi-diagram-3"></i> Pipeline
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#tools">
                <i class="bi bi-wrench"></i> å·¥å…·
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#outputs">
                <i class="bi bi-file-earmark-text"></i> è¾“å‡ºæ–‡ä»¶
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#reports">
                <i class="bi bi-bar-chart"></i> æŠ¥å‘Š
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#visualizations">
                <i class="bi bi-graph-up"></i> å¯è§†åŒ–
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#chat">
                <i class="bi bi-chat-dots"></i> Claude Chat
            </a>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content">
        <!-- Pipeline Tab -->
        <div class="tab-pane fade show active" id="pipeline">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-diagram-3"></i> Pipeline æ‰§è¡Œæ­¥éª¤</h5>
                </div>
                <div class="card-body">
                    <div id="stepsContainer" class="row">
                        <!-- Steps will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Tools Tab -->
        <div class="tab-pane fade" id="tools">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-wrench"></i> ç”Ÿæˆçš„å·¥å…·</h5>
                </div>
                <div class="card-body">
                    <div id="toolsContainer" class="row">
                        <!-- Tools will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Outputs Tab -->
        <div class="tab-pane fade" id="outputs">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-file-earmark-text"></i> è¾“å‡ºæ–‡ä»¶</h5>
                </div>
                <div class="card-body">
                    <div id="outputsContainer">
                        <!-- Outputs will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div class="tab-pane fade" id="reports">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-bar-chart"></i> è´¨é‡æŠ¥å‘Š</h5>
                </div>
                <div class="card-body">
                    <div id="reportsContainer">
                        <!-- Reports will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Visualizations Tab -->
        <div class="tab-pane fade" id="visualizations">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-graph-up"></i> å¯è§†åŒ–ç»“æœ</h5>
                </div>
                <div class="card-body">
                    <div id="visualizationsContainer" class="row">
                        <!-- Visualizations will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Tab -->
        <div class="tab-pane fade" id="chat">
            <!-- Configuration Wizard -->
            <div id="chatConfigWizard">
                <div class="card border-primary mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-gear"></i> é…ç½® Claude è¿æ¥
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">é¦–æ¬¡ä½¿ç”¨éœ€è¦é…ç½®è¿æ¥æ–¹å¼ï¼Œä¹‹åå¯ä»¥ç›´æ¥å¯¹è¯</p>
                        
                        <div class="mb-4">
                            <label class="form-label fw-bold">é€‰æ‹©è¿æ¥æ–¹å¼ï¼š</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="chatMethod" id="methodMcp" value="mcp" checked>
                                <label class="btn btn-outline-primary" for="methodMcp">
                                    <i class="bi bi-star-fill"></i> Claude Desktop/Code (æ¨è)
                                </label>
                                
                                <input type="radio" class="btn-check" name="chatMethod" id="methodApi" value="api">
                                <label class="btn btn-outline-secondary" for="methodApi">
                                    <i class="bi bi-key"></i> API ç›´æ¥è°ƒç”¨
                                </label>
                            </div>
                        </div>
                        
                        <!-- MCP Configuration -->
                        <div id="mcpConfig" class="config-section">
                            <div class="alert alert-success">
                                <strong>âœ… æ¨èä½¿ç”¨ Claude Desktop/Code</strong>
                                <ul class="mb-0 mt-2 small">
                                    <li>æ— éœ€é¢å¤– API è´¹ç”¨ (ä½¿ç”¨è®¢é˜…ç‰ˆ)</li>
                                    <li>å®Œæ•´çš„å¯¹è¯ä½“éªŒå’Œä¸Šä¸‹æ–‡</li>
                                    <li>è‡ªåŠ¨å·¥å…·è°ƒç”¨</li>
                                </ul>
                            </div>
                            
                            <div class="card bg-light mb-3">
                                <div class="card-body">
                                    <h6><i class="bi bi-1-circle-fill text-primary"></i> å®‰è£… MCP æœåŠ¡å™¨</h6>
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control font-monospace small" 
                                               id="mcpInstallCmdInput" readonly>
                                        <button class="btn btn-outline-secondary" onclick="copyMcpInstallCmd()">
                                            <i class="bi bi-clipboard"></i>
                                        </button>
                                    </div>
                                    <small class="text-muted">å¤åˆ¶å‘½ä»¤å¹¶åœ¨ç»ˆç«¯æ‰§è¡Œ</small>
                                </div>
                            </div>
                            
                            <div class="card bg-light mb-3">
                                <div class="card-body">
                                    <h6><i class="bi bi-2-circle-fill text-primary"></i> å¯åŠ¨ Claude</h6>
                                    <code class="d-block bg-dark text-light p-2 rounded">claude</code>
                                    <small class="text-muted d-block mt-2">åœ¨ç»ˆç«¯è¿è¡Œæ­¤å‘½ä»¤</small>
                                </div>
                            </div>
                            
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="mcpInstalledCheck">
                                <label class="form-check-label" for="mcpInstalledCheck">
                                    æˆ‘å·²å®Œæˆ MCP é…ç½®å¹¶åœ¨å¦ä¸€ä¸ªçª—å£å¯åŠ¨äº† Claude
                                </label>
                            </div>
                            
                            <button class="btn btn-primary" onclick="completeMcpConfig()" disabled id="mcpCompleteBtn">
                                <i class="bi bi-check-circle"></i> å®Œæˆé…ç½®ï¼Œå¼€å§‹å¯¹è¯
                            </button>
                        </div>
                        
                        <!-- API Configuration -->
                        <div id="apiConfig" class="config-section" style="display: none;">
                            <div class="alert alert-warning">
                                <strong>âš ï¸ ä½¿ç”¨ API ç›´æ¥è°ƒç”¨</strong>
                                <ul class="mb-0 mt-2 small">
                                    <li>éœ€è¦ Anthropic API å¯†é’¥</li>
                                    <li>ä¼šäº§ç”Ÿ API è°ƒç”¨è´¹ç”¨</li>
                                    <li>åœ¨æµè§ˆå™¨ä¸­ç›´æ¥å¯¹è¯</li>
                                </ul>
                            </div>
                            
                            <div class="mb-3">
                                <label for="chatApiKey" class="form-label">
                                    <i class="bi bi-key"></i> Anthropic API Key
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-shield-lock"></i></span>
                                    <input type="password" class="form-control" id="chatApiKey" 
                                           placeholder="sk-ant-api03-...">
                                    <button class="btn btn-outline-secondary" type="button" 
                                            onclick="toggleChatApiKeyVisibility()">
                                        <i class="bi bi-eye" id="chatApiKeyToggleIcon"></i>
                                    </button>
                                </div>
                                <small class="text-muted">ä» console.anthropic.com è·å–</small>
                            </div>
                            
                            <button class="btn btn-primary" onclick="completeApiConfig()">
                                <i class="bi bi-check-circle"></i> ä¿å­˜é…ç½®ï¼Œå¼€å§‹å¯¹è¯
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chat Interface -->
            <div id="chatInterface" style="display: none;">
                <div class="card">
                    <div class="card-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-0">
                                    <i class="bi bi-robot"></i> Claude Assistant
                                </h5>
                                <small id="chatMethodIndicator">è¿æ¥æ–¹å¼ï¼šåŠ è½½ä¸­...</small>
                            </div>
                            <button class="btn btn-sm btn-light" onclick="reconfigureChat()">
                                <i class="bi bi-gear"></i> é‡æ–°é…ç½®
                            </button>
                        </div>
                    </div>
                    <div class="card-body" style="height: 500px; display: flex; flex-direction: column;">
                        <!-- Messages Container -->
                        <div id="chatMessages" class="flex-grow-1 overflow-auto mb-3 p-3 bg-light rounded">
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-chat-dots display-1"></i>
                                <p class="mt-3">å¼€å§‹å¯¹è¯...</p>
                            </div>
                        </div>
                        
                        <!-- Input Area -->
                        <div>
                            <!-- File upload area -->
                            <div id="chatFileList" class="mb-2" style="display: none;">
                                <div class="d-flex flex-wrap gap-2" id="chatFiles"></div>
                            </div>
                            
                            <!-- Message input -->
                            <div class="input-group">
                                <input type="file" 
                                       id="chatFileInput" 
                                       style="display: none;"
                                       accept=".csv,.txt,.json,.xlsx,.xls"
                                       multiple
                                       onchange="handleChatFileUpload(this)">
                                <button class="btn btn-outline-secondary" 
                                        type="button" 
                                        onclick="document.getElementById('chatFileInput').click()"
                                        title="ä¸Šä¼ æ–‡ä»¶">
                                    <i class="bi bi-paperclip"></i>
                                </button>
                                <input type="text" class="form-control" id="chatInput" 
                                       placeholder="è¾“å…¥æ¶ˆæ¯..." 
                                       onkeypress="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendChatMessage(); }">
                                <button class="btn btn-primary" onclick="sendChatMessage()" id="sendChatBtn">
                                    <i class="bi bi-send"></i> å‘é€
                                </button>
                            </div>
                            
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-lightbulb"></i> 
                                    <span id="chatTip">å¯ä»¥è¦æ±‚ Claude ä½¿ç”¨ç”Ÿæˆçš„ MCP å·¥å…· | <i class="bi bi-paperclip"></i> æ”¯æŒä¸Šä¼  CSV, TXT, JSON, Excel æ–‡ä»¶</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- MCP Tools Panel -->
                <div class="row mt-3">
                    <!-- Available Tools -->
                    <div class="col-md-4">
                        <div class="card" style="height: 500px; display: flex; flex-direction: column;">
                            <div class="card-header bg-primary text-white" style="flex-shrink: 0;">
                                <h6 class="mb-0">
                                    <i class="bi bi-tools"></i> å¯ç”¨å·¥å…· 
                                    <span class="badge bg-light text-primary" id="toolCount">0</span>
                                </h6>
                            </div>
                            <div class="card-body p-0" style="flex: 1; overflow-y: auto;">
                                <div id="toolsList" class="list-group list-group-flush">
                                    <div class="text-center text-muted py-3">
                                        <div class="spinner-border spinner-border-sm"></div>
                                        <p class="small mt-2 mb-0">åŠ è½½å·¥å…·...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tool Details & Executor -->
                    <div class="col-md-8">
                        <div class="card" style="height: 500px; display: flex; flex-direction: column;">
                            <div class="card-header bg-success text-white" style="flex-shrink: 0;">
                                <h6 class="mb-0">
                                    <i class="bi bi-play-circle"></i> å·¥å…·æ‰§è¡Œå™¨
                                </h6>
                            </div>
                            <div class="card-body" style="flex: 1; overflow-y: auto; padding: 1rem;">
                                <div id="toolDetailsEmpty" class="text-center text-muted py-5">
                                    <i class="bi bi-cursor display-1"></i>
                                    <p class="mt-3">â† ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªå·¥å…·</p>
                                </div>
                                
                                <div id="toolDetailsContent" style="display: none;">
                                    <h5 id="selectedToolName" class="mb-3"></h5>
                                    <p id="selectedToolDesc" class="text-muted"></p>
                                    
                                    <hr>
                                    
                                    <form id="toolExecuteForm">
                                        <div id="toolParameters">
                                            <!-- Parameters will be populated dynamically -->
                                        </div>
                                        
                                        <div class="d-grid gap-2 mt-3">
                                            <button type="button" class="btn btn-success" onclick="executeSelectedTool()">
                                                <i class="bi bi-play-fill"></i> æ‰§è¡Œå·¥å…·
                                            </button>
                                        </div>
                                    </form>
                                    
                                    <!-- Tool Result -->
                                    <div id="toolResult" style="display: none;" class="mt-3">
                                        <h6>æ‰§è¡Œç»“æœï¼š</h6>
                                        <div class="card">
                                            <div class="card-body">
                                                <pre id="toolResultContent" class="mb-0" style="max-height: 200px; overflow-y: auto;"></pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Examples -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-lightning"></i> å¿«é€Ÿç¤ºä¾‹</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-flex flex-wrap gap-2" id="quickExamples">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
const projectName = "{{ project_name }}";

$(document).ready(function() {
    loadProjectInfo();
    loadSteps();
    loadTools();
    loadOutputs();
    loadReports();
    loadVisualizations();
    loadMcpInfo();
});

function loadProjectInfo() {
    $.get(`/api/project/${projectName}`, function(project) {
        $('#toolsCount').text(project.tools_count);
        $('#completedSteps').text(`${project.completed_steps}/10`);
        $('#mcpStatus').html(project.has_mcp ? 
            '<i class="bi bi-check-circle-fill text-success"></i>' : 
            '<i class="bi bi-x-circle"></i>');
        $('#progress').text(`${project.progress}%`);
    });
}

function loadSteps() {
    $.get(`/api/project/${projectName}/steps`, function(steps) {
        let html = '';
        steps.forEach((step, index) => {
            const statusClass = step.completed ? 'completed' : '';
            const icon = step.completed ? 
                '<i class="bi bi-check-circle-fill text-success"></i>' : 
                '<i class="bi bi-circle text-muted"></i>';
            
            html += `
                <div class="col-md-6 mb-3">
                    <div class="card step-card ${statusClass}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">${icon} ${step.title}</h6>
                                    <small class="text-muted">${step.name}</small>
                                </div>
                                ${!step.completed ? `
                                    <button class="btn btn-sm btn-primary" 
                                            onclick="executeStep('${projectName}', '${index + 1}', '${step.title}')">
                                        <i class="bi bi-play-fill"></i> æ‰§è¡Œ
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        $('#stepsContainer').html(html);
    });
}

function loadTools() {
    $.get(`/api/project/${projectName}/tools`, function(tools) {
        if (tools.length === 0) {
            $('#toolsContainer').html(`
                <div class="col-12 text-center py-5">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                    <p class="text-muted mt-3">è¿˜æ²¡æœ‰ç”Ÿæˆå·¥å…·</p>
                </div>
            `);
            return;
        }
        
        let html = '';
        tools.forEach(tool => {
            html += `
                <div class="col-md-4 mb-3">
                    <div class="card tool-card">
                        <div class="card-body">
                            <h6><i class="bi bi-file-code"></i> ${tool.name}</h6>
                            <small class="text-muted">${tool.filename}</small>
                            <div class="mt-2">
                                <span class="badge bg-primary">${tool.lines} è¡Œ</span>
                                <span class="badge bg-secondary">${formatFileSize(tool.size)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        $('#toolsContainer').html(html);
    });
}

function loadOutputs() {
    $.get(`/api/project/${projectName}/outputs`, function(outputs) {
        if (outputs.length === 0) {
            $('#outputsContainer').html(`
                <p class="text-muted">æ²¡æœ‰è¾“å‡ºæ–‡ä»¶</p>
            `);
            return;
        }
        
        let html = '<div class="list-group">';
        outputs.forEach(output => {
            html += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi bi-file-json"></i> ${output.name}
                        <br>
                        <small class="text-muted">
                            ${formatFileSize(output.size)} â€¢ ${formatDate(output.modified)}
                        </small>
                    </div>
                    <button class="btn btn-sm btn-primary" 
                            onclick="downloadFile('${projectName}', '${output.name}')">
                        <i class="bi bi-download"></i> ä¸‹è½½
                    </button>
                </div>
            `;
        });
        html += '</div>';
        $('#outputsContainer').html(html);
    });
}

function loadReports() {
    $.get(`/api/project/${projectName}/reports`, function(reports) {
        if (reports.length === 0) {
            $('#reportsContainer').html(`
                <p class="text-muted">æ²¡æœ‰ç”ŸæˆæŠ¥å‘Š</p>
            `);
            return;
        }
        
        let html = '<div class="list-group">';
        reports.forEach(report => {
            html += `
                <a href="#" class="list-group-item list-group-item-action" 
                   onclick="viewReport('${projectName}', '${report.path}'); return false;">
                    <i class="bi bi-file-text"></i> ${report.name}
                    <br>
                    <small class="text-muted">${report.path}</small>
                </a>
            `;
        });
        html += '</div>';
        $('#reportsContainer').html(html);
    });
}

function loadVisualizations() {
    $.get(`/api/project/${projectName}/visualizations`, function(visualizations) {
        if (visualizations.length === 0) {
            $('#visualizationsContainer').html(`
                <div class="col-12 text-center py-5">
                    <i class="bi bi-image display-1 text-muted"></i>
                    <p class="text-muted mt-3">è¿˜æ²¡æœ‰å¯è§†åŒ–ç»“æœ</p>
                </div>
            `);
            return;
        }
        
        let html = '';
        visualizations.forEach(viz => {
            html += `
                <div class="col-md-4 mb-3">
                    <div class="card" style="cursor: pointer;" onclick="viewImage('${viz.path}', '${viz.name}')">
                        <img src="${viz.path}" class="card-img-top" alt="${viz.name}" 
                             style="max-height: 200px; object-fit: cover;">
                        <div class="card-body">
                            <h6>${viz.name}</h6>
                            <small class="text-muted">${formatDate(viz.modified)}</small>
                        </div>
                    </div>
                </div>
            `;
        });
        $('#visualizationsContainer').html(html);
    });
}

function viewImage(imagePath, imageName) {
    const modal = $(`
        <div class="modal fade" tabindex="-1">
            <div class="modal-dialog modal-xl modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-image"></i> ${imageName}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img src="${imagePath}" class="img-fluid" alt="${imageName}">
                    </div>
                </div>
            </div>
        </div>
    `);
    
    $('body').append(modal);
    const bsModal = new bootstrap.Modal(modal[0]);
    bsModal.show();
    
    modal.on('hidden.bs.modal', function() {
        $(this).remove();
    });
}

function viewReport(projectName, reportPath) {
    $.get(`/api/project/${projectName}/report/${reportPath}`, function(data) {
        // Create modal to display report
        const modal = $(`
            <div class="modal fade" tabindex="-1">
                <div class="modal-dialog modal-xl modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="bi bi-file-text"></i> ${data.name}
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <pre class="code-display">${data.content}</pre>
                        </div>
                    </div>
                </div>
            </div>
        `);
        
        $('body').append(modal);
        const bsModal = new bootstrap.Modal(modal[0]);
        bsModal.show();
        
        modal.on('hidden.bs.modal', function() {
            $(this).remove();
        });
    });
}

// Chat functionality
let chatHistory = [];

function toggleChatApiKeyVisibility() {
    const apiKeyInput = $('#chatApiKey');
    const toggleIcon = $('#chatApiKeyToggleIcon');
    
    if (apiKeyInput.attr('type') === 'password') {
        apiKeyInput.attr('type', 'text');
        toggleIcon.removeClass('bi-eye').addClass('bi-eye-slash');
    } else {
        apiKeyInput.attr('type', 'password');
        toggleIcon.removeClass('bi-eye-slash').addClass('bi-eye');
    }
}

async function sendMessage() {
    const input = $('#chatInput');
    const apiKey = $('#chatApiKey').val();
    const message = input.val().trim();
    
    if (!message) {
        showToast('è¯·è¾“å…¥æ¶ˆæ¯', 'warning');
        return;
    }
    
    if (!apiKey) {
        showToast('è¯·å…ˆè¾“å…¥ API Key', 'warning');
        $('#chatApiKey').focus();
        return;
    }
    
    // Validate API key format
    if (!apiKey.startsWith('sk-ant-')) {
        showToast('API Key æ ¼å¼ä¸æ­£ç¡®', 'danger');
        return;
    }
    
    // Add user message to chat
    addMessageToChat('user', message);
    input.val('');
    
    // Disable send button
    const sendBtn = $('#sendBtn');
    sendBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> å¤„ç†ä¸­...');
    
    try {
        // Call backend API
        const response = await $.ajax({
            url: `/api/project/${projectName}/chat`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                message: message,
                api_key: apiKey,
                history: chatHistory
            })
        });
        
        // Add assistant response
        addMessageToChat('assistant', response.response, response.tools_used);
        
        // Update chat history
        chatHistory.push({
            role: 'user',
            content: message
        });
        chatHistory.push({
            role: 'assistant',
            content: response.response
        });
        
    } catch (error) {
        console.error('Chat error:', error);
        addMessageToChat('error', error.responseJSON?.error || 'å‘é€æ¶ˆæ¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Key æˆ–ç¨åé‡è¯•');
    } finally {
        sendBtn.prop('disabled', false).html('<i class="bi bi-send"></i> å‘é€');
    }
}

function addMessageToChat(role, content, toolsUsed = null) {
    const messagesContainer = $('#chatMessages');
    let messageHtml = '';
    
    if (role === 'user') {
        messageHtml = `
            <div class="chat-message user-message mb-3">
                <div class="d-flex justify-content-end">
                    <div class="message-bubble bg-primary text-white p-3 rounded" style="max-width: 70%;">
                        <div class="message-content">${escapeHtml(content)}</div>
                        <small class="text-white-50 d-block mt-1">
                            <i class="bi bi-person-fill"></i> æ‚¨ Â· ${new Date().toLocaleTimeString('zh-CN')}
                        </small>
                    </div>
                </div>
            </div>
        `;
    } else if (role === 'assistant') {
        let toolsHtml = '';
        if (toolsUsed && toolsUsed.length > 0) {
            toolsHtml = `
                <div class="tools-used mt-2 p-2 bg-light rounded">
                    <small class="text-muted">
                        <i class="bi bi-wrench"></i> ä½¿ç”¨çš„å·¥å…·: 
                        ${toolsUsed.map(t => `<span class="badge bg-info">${t}</span>`).join(' ')}
                    </small>
                </div>
            `;
        }
        messageHtml = `
            <div class="chat-message assistant-message mb-3">
                <div class="d-flex">
                    <div class="message-bubble bg-light p-3 rounded" style="max-width: 70%;">
                        <div class="message-content">${formatMarkdown(content)}</div>
                        ${toolsHtml}
                        <small class="text-muted d-block mt-1">
                            <i class="bi bi-robot"></i> Claude Â· ${new Date().toLocaleTimeString('zh-CN')}
                        </small>
                    </div>
                </div>
            </div>
        `;
    } else if (role === 'error') {
        messageHtml = `
            <div class="chat-message error-message mb-3">
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> ${escapeHtml(content)}
                </div>
            </div>
        `;
    }
    
    messagesContainer.append(messageHtml);
    messagesContainer.scrollTop(messagesContainer[0].scrollHeight);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatMarkdown(text) {
    // Simple markdown formatting
    return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code>$1</code>')
        .replace(/\n/g, '<br>');
}

// Load MCP information
function loadMcpInfo() {
    const repoName = projectName.toLowerCase();
    const basePath = `${projectName}_Agent`;
    
    // Generate MCP install command
    const installCmd = `cd ${basePath} && fastmcp install claude-code src/${repoName}_mcp.py --python ${repoName}-env/bin/python`;
    $('#mcpInstallCmd').text(installCmd);
    
    // Generate example query
    $.get(`/api/project/${projectName}/tools`, function(tools) {
        if (tools.length > 0) {
            const firstTool = tools[0].name;
            const exampleQuery = `è¯·ä½¿ç”¨ ${firstTool} å·¥å…·å¸®æˆ‘å®Œæˆç›¸å…³ä»»åŠ¡`;
            $('#exampleQuery').text(exampleQuery);
            
            // Generate Python example
            const pythonExample = `import anthropic
import json

# åˆå§‹åŒ– Claude å®¢æˆ·ç«¯
client = anthropic.Anthropic(api_key="your-api-key-here")

# åŠ è½½ MCP å·¥å…·å®šä¹‰
# ä» ${basePath}/src/${repoName}_mcp.py ä¸­è·å–

# å‘é€è¯·æ±‚
message = client.messages.create(
    model="claude-sonnet-4-20250514",
    max_tokens=4096,
    tools=[
        # åœ¨è¿™é‡Œæ·»åŠ ä» MCP æœåŠ¡å™¨è·å–çš„å·¥å…·å®šä¹‰
    ],
    messages=[
        {
            "role": "user",
            "content": "ä½¿ç”¨ ${firstTool} å·¥å…·å¤„ç†æ•°æ®"
        }
    ]
)

print(message.content)`;
            $('#pythonExample').text(pythonExample);
            
            // Generate curl example
            const curlExample = `curl https://api.anthropic.com/v1/messages \\
  -H "Content-Type: application/json" \\
  -H "X-API-Key: $ANTHROPIC_API_KEY" \\
  -H "anthropic-version: 2023-06-01" \\
  -d '{
    "model": "claude-sonnet-4-20250514",
    "max_tokens": 4096,
    "tools": [
      // ä» MCP æœåŠ¡å™¨è·å–çš„å·¥å…·å®šä¹‰
    ],
    "messages": [
      {
        "role": "user",
        "content": "ä½¿ç”¨ ${firstTool} å·¥å…·"
      }
    ]
  }'`;
            $('#curlExample').text(curlExample);
            
            // Load tools list
            loadMcpToolsList(tools);
        }
    });
}

function loadMcpToolsList(tools) {
    if (tools.length === 0) {
        $('#mcpToolsList').html('<p class="text-muted">è¿˜æ²¡æœ‰ç”Ÿæˆ MCP å·¥å…·</p>');
        return;
    }
    
    let html = '<div class="row">';
    tools.forEach((tool, index) => {
        html += `
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="bi bi-wrench"></i> ${tool.name}
                        </h6>
                        <p class="card-text">
                            <small class="text-muted">
                                æ–‡ä»¶: ${tool.filename}<br>
                                ä»£ç è¡Œæ•°: ${tool.lines} è¡Œ
                            </small>
                        </p>
                        <span class="badge bg-primary">${tool.filename.replace('.py', '')}</span>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    $('#mcpToolsList').html(html);
}

// Copy functions
function copyMcpInstallCmd() {
    const text = $('#mcpInstallCmd').text();
    copyToClipboard(text);
}

function copyPythonExample() {
    const text = $('#pythonExample').text();
    copyToClipboard(text);
}

function copyCurlExample() {
    const text = $('#curlExample').text();
    copyToClipboard(text);
}

// ========== Chat Functions ==========

// Chat configuration state
let chatConfig = {
    method: null, // 'mcp' or 'api'
    apiKey: null,
    conversationHistory: []
};

// Initialize chat tab
function initChat() {
    // Check if config exists in localStorage
    const savedConfig = localStorage.getItem('chatConfig_' + projectName);
    if (savedConfig) {
        chatConfig = JSON.parse(savedConfig);
        showChatInterface();
    } else {
        showConfigWizard();
    }
    
    // Update MCP install command
    const repoName = projectName.toLowerCase();
    const basePath = `${projectName}_Agent`;
    const installCmd = `fastmcp install claude-code ${basePath}/src/${repoName}_mcp.py --python ${basePath}/${repoName}-env/bin/python`;
    $('#mcpInstallCmdInput').val(installCmd);
    
    // Setup method toggle
    $('input[name="chatMethod"]').change(function() {
        if ($(this).val() === 'mcp') {
            $('#mcpConfig').show();
            $('#apiConfig').hide();
        } else {
            $('#mcpConfig').hide();
            $('#apiConfig').show();
        }
    });
    
    // Setup MCP checkbox
    $('#mcpInstalledCheck').change(function() {
        $('#mcpCompleteBtn').prop('disabled', !$(this).is(':checked'));
    });
    
    // Load quick examples
    loadQuickExamples();
}

function showConfigWizard() {
    $('#chatConfigWizard').show();
    $('#chatInterface').hide();
}

function showChatInterface() {
    $('#chatConfigWizard').hide();
    $('#chatInterface').show();
    
    // Update indicator
    if (chatConfig.method === 'mcp') {
        $('#chatMethodIndicator').html('<i class="bi bi-check-circle text-success"></i> Claude Desktop/Code (MCP)');
        $('#chatTip').text('Claude å·²è¿æ¥ MCP å·¥å…·ï¼Œå¯ä»¥åœ¨å¯¹è¯ä¸­è‡ªåŠ¨è°ƒç”¨');
    } else {
        $('#chatMethodIndicator').html('<i class="bi bi-key text-warning"></i> API ç›´æ¥è°ƒç”¨');
        $('#chatTip').text('ä½¿ç”¨ API å¯†é’¥ç›´æ¥è°ƒç”¨ Claude');
    }
}

function completeMcpConfig() {
    chatConfig.method = 'mcp';
    chatConfig.apiKey = null;
    
    // Save to localStorage
    localStorage.setItem('chatConfig_' + projectName, JSON.stringify(chatConfig));
    
    showChatInterface();
    addSystemMessage('âœ… MCP é…ç½®å®Œæˆï¼æ‚¨ç°åœ¨å¯ä»¥åœ¨ Claude Desktop/Code ä¸­ä½¿ç”¨å·¥å…·äº†ã€‚\n\nğŸ’¡ æç¤ºï¼šåœ¨è¿™é‡Œè¾“å…¥çš„æ¶ˆæ¯ä»…ç”¨äºæµ‹è¯•å’Œæ¼”ç¤ºã€‚å®é™…ä½¿ç”¨æ—¶ï¼Œè¯·ç›´æ¥åœ¨ Claude Desktop/Code çª—å£ä¸­å¯¹è¯ï¼Œé‚£é‡Œå¯ä»¥è‡ªåŠ¨è°ƒç”¨ MCP å·¥å…·ã€‚');
}

function completeApiConfig() {
    const apiKey = $('#chatApiKey').val();
    
    if (!apiKey || !apiKey.startsWith('sk-ant-')) {
        showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„ API å¯†é’¥', 'danger');
        return;
    }
    
    chatConfig.method = 'api';
    chatConfig.apiKey = apiKey;
    
    // Save to localStorage (without API key for security)
    const configToSave = { method: 'api', apiKey: null };
    localStorage.setItem('chatConfig_' + projectName, JSON.stringify(configToSave));
    
    showChatInterface();
    addSystemMessage('âœ… API é…ç½®å®Œæˆï¼ç°åœ¨å¯ä»¥å¼€å§‹å¯¹è¯äº†ã€‚');
}

function reconfigureChat() {
    if (confirm('ç¡®å®šè¦é‡æ–°é…ç½®å—ï¼Ÿå½“å‰å¯¹è¯å†å²å°†è¢«æ¸…é™¤ã€‚')) {
        chatConfig = { method: null, apiKey: null, conversationHistory: [] };
        localStorage.removeItem('chatConfig_' + projectName);
        $('#chatMessages').html('<div class="text-center text-muted py-5"><i class="bi bi-chat-dots display-1"></i><p class="mt-3">å¼€å§‹å¯¹è¯...</p></div>');
        showConfigWizard();
    }
}

function toggleChatApiKeyVisibility() {
    const input = $('#chatApiKey');
    const icon = $('#chatApiKeyToggleIcon');
    
    if (input.attr('type') === 'password') {
        input.attr('type', 'text');
        icon.removeClass('bi-eye').addClass('bi-eye-slash');
    } else {
        input.attr('type', 'password');
        icon.removeClass('bi-eye-slash').addClass('bi-eye');
    }
}

function sendChatMessage() {
    const input = $('#chatInput');
    const message = input.val().trim();
    
    if (!message) return;
    
    // Add user message
    addUserMessage(message);
    input.val('');
    
    // Disable input while processing
    $('#sendChatBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> å‘é€ä¸­...');
    
    if (chatConfig.method === 'mcp') {
        // MCP mode: show info message
        setTimeout(() => {
            addAssistantMessage('ğŸ’¡ æ‚¨æ­£åœ¨ä½¿ç”¨ MCP æ¨¡å¼ã€‚\n\nä¸ºäº†è·å¾—å®Œæ•´çš„å·¥å…·è°ƒç”¨ä½“éªŒï¼Œè¯·åœ¨ Claude Desktop/Code çª—å£ä¸­è¿›è¡Œå¯¹è¯ã€‚\n\nè¿™ä¸ªç•Œé¢ä¸»è¦ç”¨äºï¼š\n1. æŸ¥çœ‹å¦‚ä½•é…ç½® MCP\n2. è·å–å¿«é€Ÿç¤ºä¾‹\n3. äº†è§£å¯ç”¨å·¥å…·\n\nå¦‚éœ€å®é™…è°ƒç”¨å·¥å…·ï¼Œè¯·åˆ‡æ¢åˆ° Claude Desktop/Code æˆ–ä½¿ç”¨ API æ¨¡å¼ã€‚');
            $('#sendChatBtn').prop('disabled', false).html('<i class="bi bi-send"></i> å‘é€');
        }, 500);
    } else {
        // API mode: call Claude API
        callClaudeAPI(message);
    }
}

function callClaudeAPI(message) {
    $.ajax({
        url: '/api/project/' + projectName + '/chat',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            message: message,
            api_key: chatConfig.apiKey,
            history: chatConfig.conversationHistory,
            uploaded_files: chatUploadedFiles
        }),
        success: function(response) {
            if (response.success) {
                addAssistantMessage(response.message);
                chatConfig.conversationHistory.push(
                    { role: 'user', content: message },
                    { role: 'assistant', content: response.message }
                );
                
                // Clear uploaded files after successful message
                chatUploadedFiles = [];
                updateChatFileList();
            } else {
                addErrorMessage('API è°ƒç”¨å¤±è´¥: ' + (response.error || 'æœªçŸ¥é”™è¯¯'));
            }
        },
        error: function(xhr) {
            const error = xhr.responseJSON?.error || 'API è°ƒç”¨å¤±è´¥';
            addErrorMessage(error);
        },
        complete: function() {
            $('#sendChatBtn').prop('disabled', false).html('<i class="bi bi-send"></i> å‘é€');
        }
    });
}

function addUserMessage(message) {
    const html = `
        <div class="mb-3 d-flex justify-content-end">
            <div class="card bg-primary text-white" style="max-width: 70%;">
                <div class="card-body p-2">
                    <small><strong><i class="bi bi-person-fill"></i> æ‚¨</strong></small>
                    <p class="mb-0 mt-1">${escapeHtml(message)}</p>
                </div>
            </div>
        </div>
    `;
    $('#chatMessages').append(html);
    scrollToBottom();
}

function addAssistantMessage(message) {
    const html = `
        <div class="mb-3">
            <div class="card" style="max-width: 80%;">
                <div class="card-body p-2">
                    <small><strong><i class="bi bi-robot"></i> Claude</strong></small>
                    <div class="mt-1">${formatMessage(message)}</div>
                </div>
            </div>
        </div>
    `;
    $('#chatMessages').append(html);
    scrollToBottom();
}

function addSystemMessage(message) {
    const html = `
        <div class="mb-3">
            <div class="alert alert-info p-2 mb-0">
                <small><i class="bi bi-info-circle"></i> ${formatMessage(message)}</small>
            </div>
        </div>
    `;
    $('#chatMessages').append(html);
    scrollToBottom();
}

function addErrorMessage(message) {
    const html = `
        <div class="mb-3">
            <div class="alert alert-danger p-2 mb-0">
                <small><i class="bi bi-exclamation-triangle"></i> ${escapeHtml(message)}</small>
            </div>
        </div>
    `;
    $('#chatMessages').append(html);
    scrollToBottom();
}

function formatMessage(message) {
    // Convert newlines to <br>
    message = escapeHtml(message).replace(/\n/g, '<br>');
    // Convert code blocks
    message = message.replace(/`([^`]+)`/g, '<code>$1</code>');
    return message;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function scrollToBottom() {
    const messages = $('#chatMessages');
    messages.scrollTop(messages[0].scrollHeight);
}

function loadQuickExamples() {
    $.get('/api/project/' + projectName + '/tools', function(tools) {
        if (tools.length === 0) {
            $('#quickExamples').html('<p class="text-muted small mb-0">è¿˜æ²¡æœ‰ç”Ÿæˆå·¥å…·</p>');
            return;
        }
        
        const examples = [
            `åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„ ${projectName} å·¥å…·`,
            `ä½¿ç”¨ ${tools[0]?.name || 'tool'} å·¥å…·å¸®æˆ‘å¤„ç†æ•°æ®`,
            `æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ MCP å·¥å…·`,
            `è§£é‡Š ${projectName} é¡¹ç›®çš„åŠŸèƒ½`
        ];
        
        let html = '';
        examples.forEach(example => {
            html += `
                <button class="btn btn-sm btn-outline-primary" onclick="useExample('${example}')">
                    ${example}
                </button>
            `;
        });
        
        $('#quickExamples').html(html);
    });
}

function useExample(example) {
    $('#chatInput').val(example);
    $('#chatInput').focus();
}

// ========== MCP Tools Functions ==========

let availableTools = [];
let selectedTool = null;

function loadMcpTools() {
    $.get('/api/project/' + projectName + '/mcp/tools', function(response) {
        if (response.success) {
            availableTools = response.tools;
            $('#toolCount').text(availableTools.length);
            renderToolsList();
        } else {
            $('#toolsList').html(`
                <div class="text-center text-muted p-3">
                    <i class="bi bi-exclamation-triangle"></i>
                    <p class="small mb-0">${response.error || 'åŠ è½½å·¥å…·å¤±è´¥'}</p>
                </div>
            `);
        }
    }).fail(function(xhr) {
        $('#toolsList').html(`
            <div class="text-center text-danger p-3">
                <i class="bi bi-x-circle"></i>
                <p class="small mb-0">æ— æ³•åŠ è½½å·¥å…·</p>
            </div>
        `);
    });
}

function renderToolsList() {
    if (availableTools.length === 0) {
        $('#toolsList').html(`
            <div class="text-center text-muted p-3">
                <i class="bi bi-inbox"></i>
                <p class="small mb-0">æ²¡æœ‰å¯ç”¨çš„å·¥å…·</p>
            </div>
        `);
        return;
    }
    
    let html = '';
    availableTools.forEach((tool, index) => {
        html += `
            <a href="javascript:void(0)" 
               class="list-group-item list-group-item-action tool-item" 
               data-tool-index="${index}"
               onclick="selectTool(${index})">
                <div class="d-flex w-100 justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1 small">
                            <i class="bi bi-wrench text-primary"></i> ${tool.name}
                        </h6>
                        <p class="mb-0 small text-muted text-truncate" style="max-width: 250px;">
                            ${tool.description}
                        </p>
                    </div>
                    <i class="bi bi-chevron-right text-muted"></i>
                </div>
            </a>
        `;
    });
    
    $('#toolsList').html(html);
}

function selectTool(index) {
    selectedTool = availableTools[index];
    
    // Update active state
    $('.tool-item').removeClass('active');
    $(`.tool-item[data-tool-index="${index}"]`).addClass('active');
    
    // Show tool details
    $('#toolDetailsEmpty').hide();
    $('#toolDetailsContent').show();
    $('#toolResult').hide();
    
    // Populate tool details
    $('#selectedToolName').html(`<i class="bi bi-wrench text-success"></i> ${selectedTool.name}`);
    $('#selectedToolDesc').text(selectedTool.description);
    
    // Generate parameter inputs
    const params = selectedTool.input_schema?.properties || {};
    const required = selectedTool.input_schema?.required || [];
    
    let paramsHtml = '';
    
    if (Object.keys(params).length === 0) {
        paramsHtml = '<p class="text-muted small">æ­¤å·¥å…·ä¸éœ€è¦å‚æ•°</p>';
    } else {
        paramsHtml = '<h6 class="mb-3">å‚æ•°ï¼š</h6>';
        
        for (const [paramName, paramInfo] of Object.entries(params)) {
            const isRequired = required.includes(paramName);
            const paramType = paramInfo.type || 'string';
            
            paramsHtml += `
                <div class="mb-3">
                    <label for="param_${paramName}" class="form-label small">
                        ${paramName}
                        ${isRequired ? '<span class="text-danger">*</span>' : ''}
                        <span class="text-muted">(${paramType})</span>
                    </label>
            `;
            
            if (paramInfo.description) {
                paramsHtml += `<small class="d-block text-muted mb-1">${paramInfo.description}</small>`;
            }
            
            // Check if this parameter is an INPUT file path (not output)
            const isOutputParam = paramName.toLowerCase().includes('output') ||
                                paramName.toLowerCase().includes('out_') ||
                                paramName.toLowerCase().includes('result') ||
                                paramName.toLowerCase().includes('save') ||
                                paramName.toLowerCase().includes('export') ||
                                (paramInfo.description && (
                                    paramInfo.description.toLowerCase().includes('output') ||
                                    paramInfo.description.toLowerCase().includes('save') ||
                                    paramInfo.description.toLowerCase().includes('export')
                                ));
            
            const isFilePath = !isOutputParam && (
                             paramName.toLowerCase().includes('file') || 
                             paramName.toLowerCase().includes('path') || 
                             paramName.toLowerCase().includes('csv') ||
                             paramName.toLowerCase().includes('data') ||
                             (paramInfo.description && (
                                 paramInfo.description.toLowerCase().includes('input') ||
                                 paramInfo.description.toLowerCase().includes('file') ||
                                 paramInfo.description.toLowerCase().includes('path') ||
                                 paramInfo.description.toLowerCase().includes('csv') ||
                                 paramInfo.description.toLowerCase().includes('load')
                             ))
                             );
            
            // Generate appropriate input based on type
            if (paramType === 'boolean') {
                paramsHtml += `
                    <select class="form-select form-select-sm" id="param_${paramName}" ${isRequired ? 'required' : ''}>
                        <option value="">é€‰æ‹©...</option>
                        <option value="true">True</option>
                        <option value="false">False</option>
                    </select>
                `;
            } else if (paramType === 'integer' || paramType === 'number') {
                const defaultValue = paramInfo.default !== undefined ? paramInfo.default : '';
                paramsHtml += `
                    <input type="number" 
                           class="form-control form-control-sm" 
                           id="param_${paramName}" 
                           value="${defaultValue}"
                           placeholder="${defaultValue !== '' ? defaultValue : 'è¾“å…¥æ•°å€¼'}"
                           ${isRequired ? 'required' : ''}>
                `;
            } else if (paramType === 'array') {
                paramsHtml += `
                    <textarea class="form-control form-control-sm" 
                              id="param_${paramName}" 
                              rows="3"
                              placeholder="è¾“å…¥ JSON æ•°ç»„ï¼Œä¾‹å¦‚: [1, 2, 3]"
                              ${isRequired ? 'required' : ''}></textarea>
                `;
            } else if (paramType === 'object') {
                paramsHtml += `
                    <textarea class="form-control form-control-sm" 
                              id="param_${paramName}" 
                              rows="4"
                              placeholder='è¾“å…¥ JSON å¯¹è±¡ï¼Œä¾‹å¦‚: {"key": "value"}'
                              ${isRequired ? 'required' : ''}></textarea>
                `;
            } else if (isFilePath) {
                // Show file upload option for INPUT file path parameters
                paramsHtml += `
                    <div class="input-group input-group-sm">
                        <input type="text" 
                               class="form-control form-control-sm" 
                               id="param_${paramName}" 
                               placeholder="${paramInfo.default || 'ç‚¹å‡»å³ä¾§æŒ‰é’®ä¸Šä¼ è¾“å…¥æ–‡ä»¶'}"
                               ${isRequired ? 'required' : ''}
                               readonly>
                        <input type="file" 
                               id="file_${paramName}" 
                               style="display: none;"
                               accept=".csv,.txt,.json,.xlsx,.xls,.npy,.pkl,.pickle"
                               onchange="handleFileUpload(this, 'param_${paramName}')">
                        <button class="btn btn-outline-primary btn-sm" 
                                type="button"
                                onclick="document.getElementById('file_${paramName}').click()"
                                title="ä¸Šä¼ è¾“å…¥æ•°æ®æ–‡ä»¶">
                            <i class="bi bi-upload"></i> ä¸Šä¼ è¾“å…¥æ–‡ä»¶
                        </button>
                    </div>
                    <small class="text-muted">ğŸ“ ä¸Šä¼ è¾“å…¥æ•°æ® (æ”¯æŒ: CSV, TXT, JSON, Excel, NPY, PKL)</small>
                `;
            } else if (isOutputParam) {
                // Output path parameter - show folder selection
                const defaultOutputHint = `${projectName}_Agent/tmp/outputs/`;
                paramsHtml += `
                    <div class="input-group input-group-sm">
                        <input type="text" 
                               class="form-control form-control-sm" 
                               id="param_${paramName}" 
                               placeholder="${paramInfo.default || 'ç•™ç©ºä½¿ç”¨é»˜è®¤'}"
                               ${isRequired ? 'required' : ''}>
                        <button class="btn btn-outline-success btn-sm" 
                                type="button"
                                onclick="selectOutputFolder('param_${paramName}')"
                                title="é€‰æ‹©è¾“å‡ºæ–‡ä»¶å¤¹">
                            <i class="bi bi-folder2-open"></i> é€‰æ‹©æ–‡ä»¶å¤¹
                        </button>
                    </div>
                    <small class="text-muted">ğŸ’¾ é»˜è®¤è¾“å‡ºåˆ°: <code>${defaultOutputHint}</code>ï¼ˆå¯è‡ªå®šä¹‰æ–‡ä»¶å¤¹æˆ–æ–‡ä»¶åå‰ç¼€ï¼‰</small>
                `;
            } else {
                const defaultValue = paramInfo.default !== undefined && paramInfo.default !== null ? paramInfo.default : '';
                paramsHtml += `
                    <input type="text" 
                           class="form-control form-control-sm" 
                           id="param_${paramName}" 
                           value="${defaultValue}"
                           placeholder="${defaultValue !== '' ? defaultValue : 'è¾“å…¥æ–‡æœ¬'}"
                           ${isRequired ? 'required' : ''}>
                `;
            }
            
            paramsHtml += '</div>';
        }
    }
    
    $('#toolParameters').html(paramsHtml);
}

// Global variable to store uploaded chat files
let chatUploadedFiles = [];

// Select output folder using File System Access API
async function selectOutputFolder(targetParamId) {
    try {
        if ('showDirectoryPicker' in window) {
            // Use modern Directory Picker API
            const dirHandle = await window.showDirectoryPicker({
                mode: 'readwrite'
            });
            
            // Try to resolve the full path through FileSystemDirectoryHandle
            // Note: Full path is not directly accessible due to browser security
            // We'll need to ask user to confirm the path
            const folderName = dirHandle.name;
            
            // Prompt user to provide the full path since browser doesn't expose it
            const fullPath = prompt(
                `æ‚¨é€‰æ‹©äº†æ–‡ä»¶å¤¹: ${folderName}\n\n` +
                `ç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œè¯·è¾“å…¥è¯¥æ–‡ä»¶å¤¹çš„å®Œæ•´è·¯å¾„ï¼š\n\n` +
                `ä¾‹å¦‚ï¼š/home/zephyr/Documents/${folderName}`,
                `/home/zephyr/${folderName}`
            );
            
            if (fullPath) {
                $(`#${targetParamId}`).val(fullPath.trim());
                showToast(`å·²è®¾ç½®è¾“å‡ºæ–‡ä»¶å¤¹: ${fullPath}`, 'success');
            }
        } else {
            // Fallback: direct path input
            const defaultPath = `/home/zephyr/Paper2Agent-main/${projectName}_Agent/tmp/outputs`;
            const userPath = prompt(
                'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ–‡ä»¶å¤¹é€‰æ‹©ã€‚\nè¯·è¾“å…¥è¾“å‡ºæ–‡ä»¶å¤¹çš„å®Œæ•´è·¯å¾„ï¼š\n\n' +
                `é»˜è®¤è·¯å¾„: ${defaultPath}\n\n` +
                'ç¤ºä¾‹: /home/zephyr/my_results',
                defaultPath
            );
            
            if (userPath) {
                $(`#${targetParamId}`).val(userPath.trim());
                showToast(`å·²è®¾ç½®è¾“å‡ºæ–‡ä»¶å¤¹: ${userPath}`, 'success');
            }
        }
    } catch (err) {
        if (err.name !== 'AbortError') {
            console.error('é€‰æ‹©æ–‡ä»¶å¤¹å¤±è´¥:', err);
            showToast('æ–‡ä»¶å¤¹é€‰æ‹©å¤±è´¥', 'warning');
        }
    }
}

// Handle file upload for tool parameters
function handleFileUpload(input, targetParamId) {
    const file = input.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    
    // Show uploading message
    $(`#${targetParamId}`).val('ä¸Šä¼ ä¸­...');
    
    $.ajax({
        url: '/api/upload',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.success) {
                // Store the file path with a marker
                $(`#${targetParamId}`).val('__UPLOAD__:' + response.filepath);
                $(`#${targetParamId}`).attr('data-filename', response.filename);
                showToast(`æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: ${response.filename}`, 'success');
            } else {
                showToast('æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + response.error, 'danger');
                $(`#${targetParamId}`).val('');
            }
        },
        error: function(xhr) {
            showToast('æ–‡ä»¶ä¸Šä¼ å¤±è´¥', 'danger');
            $(`#${targetParamId}`).val('');
        }
    });
}

// Handle file upload for chat
function handleChatFileUpload(input) {
    const files = input.files;
    if (!files || files.length === 0) return;
    
    // Upload each file
    Array.from(files).forEach(file => {
        const formData = new FormData();
        formData.append('file', file);
        
        $.ajax({
            url: '/api/upload',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    chatUploadedFiles.push({
                        filename: response.filename,
                        filepath: response.filepath
                    });
                    updateChatFileList();
                    showToast(`æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: ${response.filename}`, 'success');
                } else {
                    showToast('æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + response.error, 'danger');
                }
            },
            error: function() {
                showToast(`æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${file.name}`, 'danger');
            }
        });
    });
    
    // Clear input
    input.value = '';
}

// Update chat file list display
function updateChatFileList() {
    if (chatUploadedFiles.length === 0) {
        $('#chatFileList').hide();
        return;
    }
    
    $('#chatFileList').show();
    let html = '';
    chatUploadedFiles.forEach((file, index) => {
        html += `
            <span class="badge bg-secondary">
                <i class="bi bi-file-earmark"></i> ${file.filename}
                <button type="button" 
                        class="btn-close btn-close-white ms-1" 
                        style="font-size: 0.6em;"
                        onclick="removeChatFile(${index})"></button>
            </span>
        `;
    });
    $('#chatFiles').html(html);
}

// Remove a file from chat upload list
function removeChatFile(index) {
    chatUploadedFiles.splice(index, 1);
    updateChatFileList();
}

function executeSelectedTool() {
    if (!selectedTool) {
        showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå·¥å…·', 'warning');
        return;
    }
    
    // Collect parameters
    const params = {};
    const paramInputs = $('#toolParameters').find('[id^="param_"]');
    
    paramInputs.each(function() {
        const paramName = $(this).attr('id').replace('param_', '');
        let value = $(this).val();
        
        // Skip if value is undefined, but process empty strings
        if (value === undefined || value === null) {
            return;
        }
        
        // Only skip empty values for file upload fields (readonly)
        if (value === '' && $(this).attr('readonly')) {
            return;
        }
        
        // Handle different input types
        if ($(this).is('textarea')) {
            // Try to parse JSON for arrays and objects
            if (value) {
                try {
                    value = JSON.parse(value);
                } catch (e) {
                    // Keep as string if not valid JSON
                }
            }
        } else if (value === 'true' || value === 'false') {
            value = value === 'true';
        } else if ($(this).attr('type') === 'number' && value !== '') {
            value = Number(value);
        } else if (!$(this).attr('type') && !isNaN(value) && value !== '' && !$(this).is('select')) {
            // For generic text inputs that contain numbers
            value = Number(value);
        }
        // For string inputs, keep as string (including empty strings)
        
        params[paramName] = value;
    });
    
    // Show loading state
    $('#toolResult').show();
    $('#toolResultContent').html('<div class="text-center"><div class="spinner-border"></div><p class="mt-2">æ‰§è¡Œä¸­...</p></div>');
    
    // Execute tool
    $.ajax({
        url: '/api/project/' + projectName + '/execute-mcp-tool',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            tool_name: selectedTool.name,
            parameters: params
        }),
        success: function(response) {
            if (response.success) {
                const resultText = typeof response.result === 'string' 
                    ? response.result 
                    : JSON.stringify(response.result, null, 2);
                
                $('#toolResultContent').html(`
                    <div class="alert alert-success mb-2">
                        <i class="bi bi-check-circle"></i> æ‰§è¡ŒæˆåŠŸ
                    </div>
                    <code>${escapeHtml(resultText)}</code>
                `);
                
                showToast('å·¥å…·æ‰§è¡ŒæˆåŠŸ', 'success');
            } else {
                $('#toolResultContent').html(`
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle"></i> æ‰§è¡Œå¤±è´¥: ${escapeHtml(response.error)}
                    </div>
                `);
                
                showToast('å·¥å…·æ‰§è¡Œå¤±è´¥', 'danger');
            }
        },
        error: function(xhr) {
            const error = xhr.responseJSON?.error || 'æ‰§è¡Œå¤±è´¥';
            $('#toolResultContent').html(`
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle"></i> ${escapeHtml(error)}
                </div>
            `);
            
            showToast('å·¥å…·æ‰§è¡Œå¤±è´¥', 'danger');
        }
    });
}

// Call initChat when chat tab is shown
$('a[data-bs-toggle="tab"]').on('shown.bs.tab', function(e) {
    if ($(e.target).attr('href') === '#chat') {
        initChat();
        loadMcpTools();
    }
});
</script>
{% endblock %}
